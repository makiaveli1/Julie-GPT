{% extends 'base.html' %}

{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/style_chatbot.css' %}" type="text/css">
{% endblock %}


{% block content %}
{% comment %} <div class="chat-container">
  <div class="card flex-grow-1">
    <div class="card-header bg-primary text-white">Chat</div>
    {% if user.is_authenticated %}
    <div class="card-header bg-primary text-white"><b>Welcome, {{user.username}}</b>  <a style="color: white;" href="{% url 'logout' %}">Logout</a> </div>
    {% else %} 
    <div class="card-header bg-primary text-white"><a style="color: white;" href="{% url 'login' %}">Login</a>  <a style="color: white;" href="{% url 'register' %}">Register</a> </div>
    {% endif %}
    <div class="card-body messages-box">
      
      <ul class="list-unstyled messages-list">
        
        {% for chat in chats %}
          {% if chat.user == request.user %}
             <li class="message sent">
          <div class="message-text">
            <div class="message-sender">
              <b>You</b>
            </div>
            <div class="message-content">
              {{chat.message}}
            </div>
          </div>
        </li>
        
        <li class="message received">
          <div class="message-text">
            <div class="message-sender">
              <b>Julie</b>
            </div>
            <div class="message-content">
              {{chat.response}}
            </div>
          </div>
        </li>

           {% endif %}
        {% endfor %}
      </ul>
      
    </div>
    <br><br>
    <br><br>
    <br><br>
  </div>
  <form class="message-form">
    {%csrf_token%}
    <div class="input-group">
      <input type="text" class="form-control message-input" placeholder="Type your message...">
      <div class="input-group-append">
        <button type="submit" class="btn btn-primary btn-send">Send</button>
      </div>
    </div>
  </form>
</div> {% endcomment %}
<div class="chatbox">
  <header>
    <span class="username">{{user.username}}</span>
    <!-- If user is not authenticated, show Login button. Otherwise, show Logout button. -->
    {% if not user.is_authenticated %}
        <a href="{% url 'login' %}"><button class="login-btn">Login</button></a>
    {% else %}
        <a href="{% url 'logout' %}"><button class="logout-btn">Logout</button></a>
    {% endif %}
</header>
<h1>Julie</h1>
<div id="chat-container">
    {% for chat in chats %}
        <div class="message">
            <b>You:</b> {{chat.message}}
        </div>
        <div class="message">
            <b>Julie:</b> {{chat.response}}
        </div>
    {% endfor %}
</div>
<div class="input-container">
    <form method="post">
        {% csrf_token %}
        <input type="text" name="message" placeholder="Type a message...">
        <button type="submit">Send</button>
    </form>
</div>

</div>
<script>
  
  {% comment %} const messagesList = document.querySelector('.messages-list');
  const messageForm = document.querySelector('.message-form');
  const messageInput = document.querySelector('.message-input');

  messageForm.addEventListener('submit', (event) => {
    event.preventDefault();

    const message = messageInput.value.trim();
    if (message.length === 0) {
      return;
    }

    const messageItem = document.createElement('li');
    messageItem.classList.add('message', 'sent');
    messageItem.innerHTML = `
        <div class="message-text">
            <div class="message-sender">
                <b>You</b>
            </div>
            <div class="message-content">
                ${message}
            </div>
        </div>`;
    messagesList.appendChild(messageItem);

    messageInput.value = '';

    fetch('', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'message': message
      })
    })
      .then(response => response.json())
      .then(data => {
        const response = data.response;
        const messageItem = document.createElement('li');
        messageItem.classList.add('message', 'received');
        messageItem.innerHTML = `
        <div class="message-text">
            <div class="message-sender">
              <b>Julie</b>
            </div>
            <div class="message-content">
                ${response}
            </div>
        </div>
          `;
        messagesList.appendChild(messageItem);
      });
  }); {% endcomment %}
  document.addEventListener("DOMContentLoaded", function() {
    const chatForm = document.querySelector(".input-container form");

    chatForm.addEventListener("submit", function(event) {
        event.preventDefault();

        const messageInput = chatForm.querySelector("input[name='message']");
        const messageText = messageInput.value;

        if (!messageText) return;

        fetch('', {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: new URLSearchParams({
                "message": messageText
            })
        })
        .then(response => response.json())
        .then(data => {
            const chatContainer = document.getElementById("chat-container");

            const userMessage = document.createElement("div");
            userMessage.classList.add("message");
            userMessage.innerHTML = `<b>You:</b> ${data.message}`;
            chatContainer.appendChild(userMessage);

            const julieMessage = document.createElement("div");
            julieMessage.classList.add("message");
            julieMessage.innerHTML = `<b>Julie:</b> ${data.response}`;
            chatContainer.appendChild(julieMessage);

            // Clear the input
            messageInput.value = "";
        });
    });

    function getCookie(name) {
      let value = "; " + document.cookie;
      let parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
  }  
});

</script>

{% endblock %}